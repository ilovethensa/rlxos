no-strip: true

variables:
  include-root: "/sysroot/"
  apps-dir: "apps"
  include-depends: false
  force-rebuild: true

script: |
  mkdir -p %{install-root}/%{datadir}/factory/%{apps-dir}/share/{applications,icons/hicolor/scalable/apps/}
  mkdir -p %{install-root}/%{datadir}/factory/%{apps-dir}/bin/
  mv /sysroot/* %{install-root}/%{datadir}/factory/%{apps-dir}

  for appImage in %{install-root}/%{datadir}/factory/%{apps-dir}/*.app ; do
    chmod +x $appImage
    $appImage --appimage-extract info
    
    getvalue() {
      val="$(cat squashfs-root/info | grep "$1:" | cut -d ':' -f2-)"
      echo ${val}
    }

    # Create Binary Links
    for b in $(getvalue bin); do
      ln -sv ../$(basename $appImage) %{install-root}/%{datadir}/factory/%{apps-dir}/bin/$b
    done

    # Install desktop file
    desktopfile=$(getvalue desktopfile)
    $appImage --appimage-extract $desktopfile
    sed -i "s#Exec=[^ ]*#Exec=/%{apps-dir}/$(basename $appImage)#g" squashfs-root/"${desktopfile}"
    cp squashfs-root/$desktopfile %{install-root}/%{datadir}/factory/%{apps-dir}/share/applications/

    # Install icon file
    icon=$(getvalue icon)
    $appImage --appimage-extract $icon
    cp squashfs-root/$icon %{install-root}/%{datadir}/factory/%{apps-dir}/share/icons/hicolor/scalable/apps/

    rm -rf squashfs-root
  done

  install -vDm0644 /dev/stdin %{install-root}/%{libdir}/systemd/system/install-apps.service << "EOF"
  [Unit]
  Description=Install Builtin Apps
  ConditionPathNotExists=/apps

  [Service]
  Type=oneshot
  ExecStart=%{bindir}/cp -rap %{datadir}/factory/apps /

  [Install]
  WantedBy=multi-user.target
  EOF
