no-strip: true

variables:
  include-root: "/sysroot/"
  apps-dir: "apps"
  include-depends: false
  force-rebuild: true

script: |
  mkdir -p %{install-root}/%{datadir}/factory/%{apps-dir}/share/{applications,icons}
  mv /sysroot/* %{install-root}/%{datadir}/factory/%{apps-dir}

  for appImage in %{install-root}/%{datadir}/factory/%{apps-dir}/*.app ; do
    chmod +x $appImage
    $appImage --appimage-extract
    bin=$(grep "^Exec=[^ ]*" squashfs-root/*.desktop | sed 's#Exec=##g' | head -n1 | awk '{print $1}')
    ln -sv $(basename $appImage) %{install-root}/%{datadir}/factory/%{apps-dir}/${bin}
    sed -i 's#Exec=[^ ]*#Exec=/%{apps-dir}/$(basename $appImage)#g' squashfs-root/*.desktop
    iconfile=$(grep "Icon=" squashfs-root/*.desktop | cut -d '=' -f2)

    for ext in png jpg svg ; do
      echo "checking squashfs-root/${iconfile}.$ext"
      if [[ -e squashfs-root/${iconfile}.$ext ]] ; then
        cp squashfs-root/${iconfile}.$ext %{install-root}/%{datadir}/factory/%{apps-dir}/share/icons/
      fi
    done
    
    mv squashfs-root/*.desktop %{install-root}/%{datadir}/factory/%{apps-dir}/share/applications/
    rm -rf squashfs-root
  done

  install -vDm0644 /dev/stdin %{install-root}/%{libdir}/systemd/system/install-apps.service << "EOF"
  [Unit]
  Description=Install Builtin Apps
  ConditionPathNotExists=/apps

  [Service]
  Type=oneshot
  ExecStart=%{bindir}/cp -rap %{datadir}/factory/apps /apps

  [Install]
  WantedBy=multi-user.target
  EOF
