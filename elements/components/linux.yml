id: linux
version: 6.3.8
release: 1
about: |
  Linux kernel, modules and headers
sources:
  - https://www.kernel.org/pub/linux/kernel/v6.x/linux-%{version}.tar.xz

environ:
  - ARCH=%{arch}
  - KBUILD_BUILD_TIMESTAMP=Fri Nov 12 12:00:00 UTC 2011
  - KBUILD_BUILD_USER=rlxos

script: |-
  cp /files/linux/config .config
  make -j1 olddefconfig

  make ${MAKEFLAGS}
  
  make -j1 INSTALL_MOD_PATH='%{install-root}/%{prefix}' modules_install
  release=$(make -s kernelrelease)
  image_name=$(make -s image_name)

  install -Dm644 -t %{install-root}/%{libdir}/modules/${release} ${image_name}
  install -Dm644 -t %{install-root}/%{libdir}/modules/${release} System.map
  install -Dm644 .config %{install-root}/%{libdir}/modules/${release}/config

  find %{install-root}/%{libdir}/modules/$release -type f -name '*.ko' | xargs -P 4 -n 2 -r xz;
  targetdir=%{install-root}/%{prefix}/src/linux-$release

  rm %{install-root}/%{libdir}/modules/$release/{source,build}

  to_copy=(
    Makefile
    Module.symvers
    .config
    "arch/x86/include"
    "arch/x86/Makefile"
    scripts
    include
  )

  if [ "$(scripts/config -s OBJTOOL)" = y ] ;then
    to_copy+=(tools/objtool/objtool)
  fi

  for file in ${to_copy[@]} ; do
    targetfile=${targetdir}/$file
    dir=$(dirname $targetfile)
    [ -d ${dir} ] || install -d $dir
    cp -aT $file $targetfile
  done

  ln -sr ${targetdir} %{install-root}%{libdir}/modules/$release/source
  ln -sr ${targetdir} %{install-root}%{libdir}/modules/$release/build

integration: |
  cd '%{libdir}/modules'
  for version in * ; do
    depmod -b %{prefix} -a $version;
  done

build-time:
  - components/coreutils.yml
  - components/kmod.yml
  - components/bc.yml
  - components/cpio.yml
  - components/xz.yml
  - components/xmlto.yml
  - components/tar.yml
  - components/libelf.yml
  - components/zstd.yml
  - components/findutils.yml
  - components/flex.yml
  - components/bison.yml
  - components/lzo.yml
