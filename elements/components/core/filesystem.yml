id: filesystem
version: 2307
release: 2
about: rlxos filesystem

no-strip: true

variables:
  codename: 2307

script: |
  for d in boot dev etc home mnt usr var opt srv/http run; do
    install -dm755 %{install-root}/$d
  done

  # install -d -m555 %{install-root}/proc
  # install -d -m555 %{install-root}/sys
  # install -d -m0750 %{install-root}/root
  # install -d -m1777 %{install-root}/tmp

  install -d %{install-root}/%{sysconfdir}/{ld.so.conf.d,skel,profile.d} %{install-root}/%{datadir}/factory/%{sysconfdir}

  for f in fstab group host.conf hosts issue nsswitch.conf \
           passwd resolv.conf securetty shells profile inputrc ; do
    install -m644 %{build-root}/$f %{install-root}/%{sysconfdir}
    install -m644 %{build-root}/$f %{install-root}/%{datadir}/factory/%{sysconfdir}
  done

  ln -s ../proc/self/mounts %{install-root}%{sysconfdir}/mtab
  for f in gshadow shadow; do
    install -m600 %{build-root}/$f %{install-root}/%{sysconfdir}
    install -m600 %{build-root}/$f %{install-root}/%{datadir}/factory/%{sysconfdir}
  done

  echo "%{version}" > %{install-root}/%{sysconfdir}/rlxos-release
  install -Dm644 %{build-root}/os-release %{install-root}/%{libdir}/os-release

  for d in cache local opt log/old lib/misc empty; do
    install -d -m755 %{install-root}/%{localstatedir}/$d
  done
  install -d -m1777 %{install-root}/%{localstatedir}/{tmp,spool/mail}

  install -d -m755 -g 50 %{install-root}/%{localstatedir}/games
  ln -s spool/mail %{install-root}/%{localstatedir}/mail
  ln -s ../run %{install-root}/%{localstatedir}/run
  ln -s ../run/lock %{install-root}/%{localstatedir}/lock

  for d in bin include lib share/{misc,pixmaps} src; do
    install -d -m755 %{install-root}/usr/$d
  done

  for d in {1..8}; do
    install -d -m755 %{install-root}/%{datadir}/man/man$d
  done

  ln -s usr/lib %{install-root}/lib
  ln -s usr/lib %{install-root}/lib64
  ln -s lib %{install-root}/usr/lib64

  ln -s usr/bin %{install-root}/bin
  ln -s usr/bin %{install-root}/sbin
  ln -s bin %{install-root}/usr/sbin

  install -D -m644 %{build-root}/sysusers %{install-root}/%{libdir}/sysusers.d/rlxos.conf
  install -D -m644 %{build-root}/tmpfiles %{install-root}/%{libdir}/tmpfiles.d/rlxos.conf
  install -D -m755 %{build-root}/env-generator %{install-root}/%{libdir}/systemd/system-environment-generators/10-rlxos


depends:
  - components/core/iana-etc.yml

sources:
  - files/filesystem/fstab
  - files/filesystem/group 
  - files/filesystem/inputrc
  - files/filesystem/issue
  - files/filesystem/shadow
  - files/filesystem/gshadow
  - files/filesystem/nsswitch.conf
  - files/filesystem/passwd
  - files/filesystem/profile
  - files/filesystem/shells
  - files/filesystem/resolv.conf
  - files/filesystem/host.conf
  - files/filesystem/hosts
  - files/filesystem/securetty
  - files/filesystem/lsb-release
  - files/filesystem/os-release
  - files/filesystem/sysusers
  - files/filesystem/tmpfiles
  - files/filesystem/env-generator
