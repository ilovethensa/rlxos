id: shadow
version: 4.13
about: Programs for handling passwords in a secure way

depends:
  - components/core/acl.yml
  - components/core/libcap.yml
  - components/core/pam.yml

sources:
  - https://github.com/shadow-maint/shadow/releases/download/%{version}/shadow-%{version}.tar.xz

pre-script: |
  sed -i "s/groups\$(EXEEXT) //" src/Makefile.in
  find man -name Makefile.in -exec sed -i "s/groups\.1 / /"   {} \;
  find man -name Makefile.in -exec sed -i "s/getspnam\.3 / /" {} \;
  find man -name Makefile.in -exec sed -i "s/passwd\.5 / /"   {} \;
  sed -e "s@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@" \
      -e "s@/var/spool/mail@/var/mail@"                 \
      -e "/PATH=/{s@/sbin:@@;s@/bin:@@}"                \
      -i etc/login.defs

configure: >
  --with-libpam
  --with-group-name-max-length=32
  --without-selinux
  --without-audit

install: exec_prefix=/usr

post-script: |
  for i in login passwd su chage ; do
    install -v -D -m 644 /files/core/pam/$i %{install-root}/etc/pam.d/$i
  done
  mv %{install-root}/usr/sbin/* %{install-root}/usr/bin/
  rmdir %{install-root}/usr/sbin

  for extra in chfn chgpasswd chpasswd chsh groupadd groupdel \
          groupmems groupmod newusers useradd userdel usermod ; do
    install -v -D -m 644 /files/core/pam/chage %{install-root}/etc/pam.d/${extra}
    sed -i "s/chage/${extra}/" %{install-root}/etc/pam.d/${extra}
  done

integration: |
  pwconv
  grpconv