id: systemd
version: 252
about: Package contains programs for controlling the startup, running, and shutdown of the system

environ:
  - LANG=en_IN.UTF-8
  - PKG_CONFIG_PATH="%{libdir}/pkgconfig"

pre-script: |
  sed '/bus_message_type_from_string/s/_pure_//' \
    -i src/libsystemd/sd-bus/bus-internal.h    &&
  sed '/devt_hash_func/s/_pure_//'               \
      -i src/basic/hash-funcs.h                  &&
  sed '/job_get_timeout/s/_pure_//'              \
      -i src/core/job.h

  sed -i -e 's/GROUP="render"/GROUP="video"/' \
       -e 's/GROUP="sgx", //' rules.d/50-udev-default.rules.in

configure: >
  -D default-dnssec=no
  -D firstboot=true
  -D install-tests=false
  -D rpmmacrosdir=no
  -D mode=release
  -D efi=true
  -D gnu-efi=true
  -D nologin-path=%{bindir}/nologin
  -D debug-shell=%{bindir}/bash
  -D default-user-shell=%{bindir}/bash
  -D dev-kvm-mode=0660
  -D fallback-hostname='rlxos'
  -D docdir=%{datadir}/doc/system-%{version}
  -Dsbat-distro='rlxos'
  -Dsbat-distro-summary='rlxos GNU/Linux'
  -Dsbat-distro-pkgname="%{id}"
  -Dsbat-distro-version="%{version}"
  -Dsbat-distro-url="https://rlxos.dev/"


post-script: |
  for i in 10-efi.conf 20-usr-A.conf 21-usr-verity-A.conf 30-usr-B.conf 31-usr-verity-B.conf 50-root.conf ; do
    install -Dm0644 %{build-root}/${i} -t %{install-root}/%{libdir}/repart.d/
  done
  
  for i in rlxos-kernel.conf rlxos-usr.conf rlxos-usr-verity.conf ; do
    install -vDm0644 %{build-root}/$i -t %{install-root}/%{libdir}/sysupdate.d/
  done

depends:
  - components/core/acl.yml
  - components/core/bash.yml
  - components/core/coreutils.yml
  - components/core/util-linux.yml
  - components/core/openssl.yml
  - components/core/iptables.yml
  - components/core/kmod.yml
  - components/core/diffutils.yml
  - components/core/grep.yml
  - components/core/openssl.yml
  - components/core/libgcrypt.yml
  - components/py/py-jinja2.yml
  - components/core/libcap.yml
  - components/core/sed.yml
  - components/core/gawk.yml
  - components/core/lz4.yml
  - components/core/libseccomp.yml
  - components/core/libelf.yml
  - components/cryptsetup.yml
  - components/core/gnu-efi.yml

build-time:
  - components/core/gcc.yml
  - components/core/meson.yml
  - components/core/expat.yml
  - components/core/libxslt.yml
  - components/core/docbook-xsl.yml

sources:
  - https://github.com/systemd/systemd/archive/v%{version}/systemd-%{version}.tar.gz
  - files/core/systemd-sysupdate-config/rlxos-kernel.conf
  - files/core/systemd-sysupdate-config/rlxos-usr.conf
  - files/core/systemd-sysupdate-config/rlxos-usr-verity.conf
  - files/core/systemd-repart-config/10-efi.conf
  - files/core/systemd-repart-config/20-usr-A.conf
  - files/core/systemd-repart-config/21-usr-verity-A.conf
  - files/core/systemd-repart-config/30-usr-B.conf
  - files/core/systemd-repart-config/31-usr-verity-B.conf
  - files/core/systemd-repart-config/50-root.conf
