id: docker
version: 24.0.5
about: Pack, ship and run any application as a lightweight container

script: |-
  export GOPATH=%{build-root}
  mkdir -p src/github.com/docker
  cd src/github.com/docker
  ln -s %{build-root}/cli-%{version} cli
  cd cli
  make VERSION=%{version} dynbinary

  cd
  ../
  ln -s %{build-root}/moby-%{version} docker
  cd docker
  VERSION=%{version} hack/make.sh
  dynbinary
  ls -al bundles/dynbinary-daemon/
  cd ../
  ln -s %{build-root}/libnetwork-master
  libnetwork
  #ls -al libnetwork/
  cd libnetwork/cmd/proxy
  GOROOT=%{libdir}/go go
  build -o %{install-root}/%{bindir}/docker-proxy

  cd %{build-root}

  install -D -m 0755 cli-%{version}/build/docker %{install-root}/%{bindir}/docker
  install -D -m 0755 moby-%{version}/bundles/dynbinary-daemon/dockerd-%{version} %{install-root}/%{bindir}/dockerd


  ln -s containerd %{install-root}/%{bindir}/docker-containerd
  ln -s containerd-shim %{install-root}/%{bindir}/docker-containerd-shim
  ln -s ctr %{install-root}/%{bindir}/docker-containerd-ctr
  ln -s runc %{install-root}/%{bindir}/docker-runc

  install -D -m 0755 moby-%{version}/contrib/check-config.sh %{install-root}%{datadir}/docker/check-config.sh
  install -D -m 0755 moby-%{version}/contrib/init/systemd/docker.{service,socket} -t %{install-root}/usr/lib/systemd/system/
  install -D -m 0644 moby-%{version}/contrib/udev/80-docker.rules %{install-root}/usr/lib/udev/rules.d/80-docker.rules

depends:
  - components/containerd.yml
  - components/runc.yml
  - components/lvm2.yml
  - components/btrfs-progs.yml
  - components/cgroupfs-mount.yml
build-depends:
  - components/go.yml
sources:
  - https://github.com/moby/moby/archive/v%{version}/moby-%{version}.tar.gz
  - https://github.com/docker/cli/archive/v%{version}/cli-%{version}.tar.gz
  - libnetwork-0.3.tar.gz::https://github.com/moby/libnetwork/archive/refs/heads/master.tar.gz
