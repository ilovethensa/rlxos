id: p11-kit
version: 0.24.0
about: |
  Provides a way to load and enumerate PKCS #11 (a Cryptographic Token Interface Standard) modules

sources:
  - https://github.com/p11-glue/p11-kit/releases/download/{{version}}/p11-kit-{{version}}.tar.xz

depends:
  runtime:
    - libtasn1

build-dir: p11-kit-{{version}}
pre-script: |
  sed "20,$ d" -i trust/trust-extract-compat &&
  cat >> trust/trust-extract-compat << "EOF"
  # Copy existing anchor modifications to /etc/ssl/local
  /usr/lib/make-ca/copy-trust-modifications

  # Generate a new trust store
  /usr/bin/make-ca -f -g
  EOF

build-type: meson 
configure: -D trust_paths=/etc/pki/anchors --buildtype=release
post-script: |
  ln -sfv /usr/lib/p11-kit/trust-extract-compact \
    ${pkgupd_pkgdir}/usr/bin/update-ca-certificates

  ln -sfv ./pkcs11/p11-kit-trust.so ${pkgupd_pkgdir}/usr/lib/libnssckbi.so
      