merge: [version.yml]
no-strip: true

variables:
  include-root: "/sysroot"
  salt: 5ceca5e1f86ae62403b27e66c5160717f1bb88405a1d1d0853241c27f3764843

script: |
  mkdir -p %{install-root}

  [[ -d %{include-root}/%{datadir}/factory/etc ]] && rm -rf %{include-root}/%{datadir}/factory/etc
  mkdir -p %{include-root}/%{datadir}/factory
  mv -T %{include-root}/etc %{include-root}/%{datadir}/factory/etc

  echo "IMAGE_VERSION=%{version}" >>%{include-root}/%{libdir}/os-release

  mkdir -p "%{include-root}/%{libdir}/systemd/system/systemd-firstboot.service.d/"
  cat <<EOF >"%{include-root}/%{libdir}/systemd/system/systemd-firstboot.service.d/no-prompt.conf"
  [Service]
  ExecStart=
  ExecStart=/usr/bin/systemd-firstboot --root-password=root
  StandardOutput=journal
  StandardInput=null
  StandardError=journal
  EOF

  mkdir -p "%{include-root}/%{libdir}/systemd/system/ldconfig.service.d/"
  cat <<EOF >"%{include-root}/%{libdir}/systemd/system/ldconfig.service.d/after-tmpfiles.conf"
  [Unit]
  After=systemd-tmpfiles-setup.service
  EOF

  cat >%{include-root}/%{libdir}/tmpfiles.d/extra-etc.conf << EOF

  EOF

  mksquashfs %{include-root}/usr %{install-root}/usr_%{version}.squashfs

  usr_part_uuid="$(cat "%{install-root}/usr-root-hash.txt" | sed -E 's/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12}).*/\1\2\3\4\5/')"
  mv "%{install-root}/usr_%{version}.squashfs" "%{install-root}/usr_%{version}_${usr_part_uuid}.squashfs"
  ln -s "usr_%{version}_${usr_part_uuid}.squashfs" '%{install-root}/usr.squashfs'

  usr_verity_part_uuid="$(cat "%{install-root}/usr-root-hash.txt" | sed -E 's/.*([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})$/\1\2\3\4\5/')"
  mv "%{install-root}/usr_%{version}.verity" "%{install-root}/usr_%{version}_${usr_verity_part_uuid}.verity"
  ln -s "usr_%{version}_${usr_verity_part_uuid}.verity" '%{install-root}/usr.verity'

build-time:
  - components/cryptsetup.yml
  - components/squashfs-tools.yml
  - components/systemd.yml

include:
  - components/core.yml
  - components/release-info.yml
  - components/swupd.yml
  - components/layers.yml
  - components/vim.yml

  - components/tzdata.yml
  - components/strace.yml
  - components/grub.yml
  - components/mkinitramfs.yml
  - components/squashfs-tools.yml
  - components/e2fsprogs.yml
  - components/linux.yml

  # Desktop Environment
  - components/awesome.yml

  # Fonts
  - components/fonts/cantarell.yml

  # Apps
  - apps/foot.yml
