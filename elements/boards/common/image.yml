merge: [version.yml]
no-strip: true

variables:
  include-root: "/sysroot"
  salt: 5ceca5e1f86ae62403b27e66c5160717f1bb88405a1d1d0853241c27f3764843
  force-rebuild: true

script: |
  mkdir -p %{install-root}

  chroot %{include-root} /bin/bash << "EOT"
  export GDK_PIXBUF_MODULEDIR=%{localstatedir}/cache/gdk-pixbuf/
  if [ -d %{localstatedir}/lib/integrations ] ; then
    for i in %{localstatedir}/lib/integrations/* ; do
      echo "=> integrating $(basename $i)"
      sh -e $i
    done
  fi
  EOT

  install -vDm0644 /dev/stdin %{include-root}/%{sysconfdir}/environment << "EOF"
  export GTK_CSD=1
  export GDK_PIXBUF_MODULEDIR=%{localstatedir}/cache/gdk-pixbuf/
  EOF

  install -vDm0644 /dev/stdin %{include-root}/%{libdir}/tmpfiles.d/extra-etc.conf << "EOF"
  C /etc/environment
  EOF


  [[ -d %{include-root}/%{datadir}/factory/etc ]] && rm -rf %{include-root}/%{datadir}/factory/etc
  mkdir -p %{include-root}/%{datadir}/factory
  mv -T %{include-root}/etc %{include-root}/%{datadir}/factory/etc

  cp %{include-root}/%{datadir}/factory/etc/os-release %{include-root}/%{libdir}/
  echo "IMAGE_VERSION=%{version}" >> %{include-root}/%{libdir}/os-release

  mkdir -p "%{include-root}/%{libdir}/systemd/system/systemd-firstboot.service.d/"
  cat <<EOF >"%{include-root}/%{libdir}/systemd/system/systemd-firstboot.service.d/no-prompt.conf"
  [Service]
  ExecStart=
  ExecStart=/usr/bin/systemd-firstboot --root-password=root
  StandardOutput=journal
  StandardInput=null
  StandardError=journal
  EOF

  mkdir -p "%{include-root}/%{libdir}/systemd/system/ldconfig.service.d/"
  cat <<EOF >"%{include-root}/%{libdir}/systemd/system/ldconfig.service.d/after-tmpfiles.conf"
  [Unit]
  After=systemd-tmpfiles-setup.service
  EOF

  mksquashfs %{include-root}/usr %{install-root}/usr_%{version}.squashfs -comp zstd -Xcompression-level 12 -noappend

  veritysetup format --salt="%{salt}" "%{install-root}/usr_%{version}.squashfs" "%{install-root}/usr_%{version}.verity" | sed '/^Root hash:[[:space:]]*/{;s///;q;};d' >"%{install-root}/usr-root-hash.txt"

  usr_part_uuid="$(cat "%{install-root}/usr-root-hash.txt" | sed -E 's/^([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12}).*/\1\2\3\4\5/')"
  mv "%{install-root}/usr_%{version}.squashfs" "%{install-root}/usr_%{version}_${usr_part_uuid}.squashfs"
  ln -s "usr_%{version}_${usr_part_uuid}.squashfs" '%{install-root}/usr.squashfs'

  usr_verity_part_uuid="$(cat "%{install-root}/usr-root-hash.txt" | sed -E 's/.*([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})$/\1\2\3\4\5/')"
  mv "%{install-root}/usr_%{version}.verity" "%{install-root}/usr_%{version}_${usr_verity_part_uuid}.verity"
  ln -s "usr_%{version}_${usr_verity_part_uuid}.verity" '%{install-root}/usr.verity'

build-time:
  - components/cryptsetup.yml
  - components/squashfs-tools.yml
  - components/systemd.yml

include:
  # Core
  - components/core.yml
  - components/release-info.yml
  - components/linux.yml
  - components/firmware.yml
  - components/tzdata.yml
  - components/grub.yml
  - components/mkinitramfs.yml

  # Utilities
  - components/e2fsprogs.yml
  - components/vim.yml
  - components/squashfs-tools.yml
  - components/wget.yml
  - components/sudo.yml

  # rlxos
  - components/swupd.yml
  - components/layers.yml
  - components/bolt.yml
  - components/app.yml

  # Desktop Environment
  - components/xfce4.yml
  - components/lightdm.yml
  - components/lightdm-gtk-greeter.yml

  # AppImage
  - components/fuse2.yml

  # X11
  - components/x11/xserver.yml
  - components/x11/xinit.yml
  - components/x11/xf86-input-libinput.yml
  - components/x11/xrdb.yml
  - components/x11/iceauth.yml

  # Components
  - components/gvfs.yml
  - components/xdg-user-dirs-gtk.yml

  # Fonts
  - components/fonts/cantarell.yml
  - components/fonts/adobe-source-code-pro-fonts.yml
  - components/fonts/noto.yml
  - components/fonts/noto-emoji.yml
  - components/fonts/noto-cjk.yml
  - components/fonts/dejavu-fonts.yml

  # Libraries
  - components/libgtop.yml
  - components/libwnck.yml
  - components/libnotify.yml
  - components/librsvg.yml
  - components/pulseaudio.yml
  - components/upower.yml

  # Themes and Icons
  - components/themes/adwaita-icon-theme.yml
  - components/themes/qogir-gtk-theme.yml
  - components/themes/qogir-icon-theme.yml

  # Apps
  - boards/common/apps.yml
