merge: [version.yml]
no-strip: true

variables:
  installer-volume-id: RLXOS
  include-root: /sysroot
  root-password: rlxos
  cmdline: live root=LABEL=RLXOS console=tty0 console=ttyS0

build-time:
  - components/core.yml
  - components/e2fsprogs.yml
  - components/linux.yml
  - components/mkinitramfs.yml
  - components/mtools.yml
  - components/grub.yml
  - components/systemd.yml
  - components/cryptsetup.yml
  - components/squashfs-tools.yml

script: |
  mkdir -p ISO/boot/grub

  cp -r /sysroot/usr*.squashfs ISO/
  cp -r /sysroot/usr*.verity ISO/
  mv /sysroot/%{id}-live-config ISO/live-config.img

  kerver=$(ls /lib/modules | head -n1)
  cp /lib/modules/${kerver}/bzImage ISO/boot/vmlinuz-${kerver}

  echo "
  set timeout=5
  set default='rlxos GNU/Linux'

  insmod all_video

  menuentry 'rlxos GNU/Linux' {
    linux /boot/vmlinuz-${kerver} %{cmdline}
    initrd /boot/initramfs-${kerver}.img
  }" > ISO/boot/grub/grub.cfg

  mkinitramfs -u -k=${kerver} --no-plymouth -o=$(pwd)/ISO/boot/initramfs-${kerver}.img

  mkdir -p %{install-root}/
  grub-mkrescue -volid %{installer-volume-id} -o %{install-root}/rlxos-%{id}-installer.iso ISO/
  cd %{install-root}
  sha256sum rlxos-%{id}-installer.iso >rlxos-%{id}-installer.iso.sha265sum
