id: amd64-installer
merge: [version.yml, elements/include/iso.yml]
about: System Image [AMD64]
no-strip: true

include:
  - boards/amd64/image.yml

variables:
  installer-volume-id: RLXOS
  include-root: /sysroot
  root-password: rlxos
  cmdline: live root=LABEL=RLXOS
  force-rebuild: true
  liveconfig: |-
    # Create Live User
    install -vDm 0644 /dev/stdin %{liveconfig-path}/lib/systemd/system/live-user.service << "EOF"
    [Unit]
    Description=Create Live User
    Before=graphical.target
    After=systemd-tmpfiles-setup.service


    [Service]
    Type=simple
    ExecStart=/usr/bin/useradd -g users -G wheel,adm -m %{liveuser}

    [Install]
    WantedBy=default.target
    EOF

    install -vDm 0644 /dev/stdin %{liveconfig-path}/lib/tmpfiles.d/%{liveuser}.conf << "EOF"
    C %{sysconfdir}/lightdm/lightdm.conf.d/12-autologin.conf
    C %{sysconfdir}/sudoers.d/%{liveuser}
    EOF

    # Authenticate to run sudo commands without password
    install -vDm 0644 /dev/stdin %{liveconfig-path}/share/factory/etc/sudoers.d/%{liveuser} << "EOF"
    %{liveuser} ALL=(ALL) NOPASSWD: ALL
    EOF

    # AutoLogin to Live User
    install -vDm 0644 /dev/stdin %{liveconfig-path}/share/factory/etc/lightdm/lightdm.conf.d/12-autologin.conf << "EOF"
    [SeatDefaults]
    autologin-user=%{liveuser}
    autologin-user-timeout=0
    autologin-session=xfce
    EOF

    # Create Installation Guide
    install -vDm 0644 /dev/stdin %{liveconfig-path}/share/factory/etc/skel/Desktop/README << "EOF"
    RLXOS GNU/Linux %{version} %{codename}

    Notes
    - Root password: 'root'
    - Live User Password: Need to set
    - Live User Have access to sudo commands without password

    Installation
    - %{bindir}/swupd clone is a CLI tool to help installation of rlxos.
    - You need a blank ext4 partition of size atleast 4 GiB
    - You might also need a EFI parition for UEFI boot support (LABEL=EFI)
    - Execute below command with your path to partition (not DISK).
    - $ %{bindir}/clone /run/iso/sysroot.img install /dev/sd?
    - reboot once installation done
    EOF
