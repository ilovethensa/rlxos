id: amd64-core-image
version: 2307
about: rlxos core system image
no-strip: true
build-type: system
include:
  - components/core.yml
  - components/core/strace.yml
  - components/core/grub.yml
  - components/core/mkinitramfs.yml
  - components/wlroots.yml

build-time:
  - components/core/grub.yml
  - components/core/squashfs-tools.yml
  - components/core/linux.yml
  - components/core/systemd.yml

variables:
  root-password: rlxos

script: |
  # executing integration scripts
  if [ -d %{localstatedir}/lib/integrations ] ; then
    for i in %{localstatedir}/lib/integrations/* ; do
      echo "=> integrating $(basename $i)"
      sh -e $i
    done
  fi

  systemd-sysusers
  systemd-tmpfiles --create || true
  systemctl preset-all
  systemctl --global preset-all

  pwconv
  grpconv

  echo -e "%{root-password}\n%{root-password}" | passwd

  for d in opt srv/http run dev; do
    install -d -m755 $d
  done

  install -d -m555 proc
  install -d -m555 sys
  install -d -m0750 root
  install -d -m1777 tmp

  install -d -m555 -g 11 srv/ftp

  install -d -m1777 var/{tmp,spool/mail}