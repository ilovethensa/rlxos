id: amd64-core-installer
version: 2307
about: rlxos core installer
no-strip: true

variables:
  installer-volume-id: RLXOS
  include-root: /sysroot
  root-password: rlxos
  cmdline: rw root=live:LABEL=RLXOS console=tty0

build-time:
  - components/core/glibc.yml
  - components/core/e2fsprogs.yml
  - components/core/linux.yml
  - components/dracut.yml
  - components/core/mtools.yml
  - components/core/grub.yml
  - components/core/systemd.yml
  - components/cryptsetup.yml
  - components/core/squashfs-tools.yml

include:
  - boards/amd64-core/usr.yml
  - boards/amd64-core/image.yml

script: |
  mkdir -p ISO/boot/grub
  mkdir -p ISO/LiveOS

  mv /sysroot/*.squashfs ISO/
  mv /sysroot/*.verity ISO/
  mv /sysroot/usr-root-hash.txt ISO/
  mv /sysroot/%{id}-image ISO/LiveOS/squashfs.img

  file ISO/LiveOS/squashfs.img

  kerver=$(ls /lib/modules | head -n1)
  cp /lib/modules/${kerver}/bzImage ISO/boot/vmlinuz-${kerver}

  echo "
  set timeout=5
  set default='rlxos GNU/Linux'

  insmod all_video

  menuentry 'rlxos GNU/Linux' {
    linux /boot/vmlinuz-${kerver} %{cmdline}
    initrd /boot/initramfs-${kerver}.img
  }" > ISO/boot/grub/grub.cfg

  dracut -v --no-machineid \
    --kernel-image /boot/vmlinuz \
    --kver ${kerver} \
    --kernel-cmdline '%{cmdline}' \
    --add dmsquash-live \
    --add bash \
    --install grep \
    --install head \
    --install tail \
    --install less \
    --install lsof \
    --omit lvm ISO/boot/initramfs-${kerver}.img
  mkdir -p %{install-root}/
  grub-mkrescue -volid %{installer-volume-id} -o %{install-root}/rlxos-%{id}.iso ISO/
