id: libvirt
version: 8.4.0
release: 4
about: API for controlling virtualization engines (openvz,kvm,qemu,virtualbox,xen,etc)
depends:
  runtime:
    - fuse
    - gnutls
    - libpciaccess
    - libssh
    - libxml2
    - numactl
    - parted
    - polkit
    - yajl
    - dmidecode
    #    - dnsmasq
    - iptables
    - gettext
    - lvm2
    #    - open-isci
    - qemu
  #    - radvd
  #    - swtpm
  #    - ceph-lib2
  buildtime:
    - iproute2
    - libxslt
    - meson
    - py-pip
#    - rpcsv-proto

sources:
  - https://libvirt.org/sources/{{id}}-{{version}}.tar.xz

pre-script: |
  sed -i 's|/sysconfig/|/conf.d/|g' \
    src/remote/libvirtd.service.in \
    tools/{libvirt-guests.service,libvirt-guests.sh,virt-pki-validate}.in \
    src/locking/virtlockd.service.in \
    src/logging/virtlogd.service.in
  sed -i 's|/usr/libexec/qemu-bridge-helper|/usr/lib/qemu/qemu-bridge-helper|g' \
    src/qemu/qemu.conf.in \
    src/qemu/test_libvirtd_qemu.aug.in

  pip install docutils

configure: >
  --libexecdir=lib/libvirt
  -Drunstatedir=/run
  -Dqemu_user=libvirt
  -Dqemu_group=libvirt
  -Dnetcf=disabled
  -Dopenwsman=disabled
  -Dapparmor=disabled
  -Dapparmor_profiles=disabled
  -Dselinux=disabled
  -Dwireshark_dissector=disabled
  -Ddriver_bhyve=disabled
  -Ddriver_hyperv=disabled
  -Ddriver_libxl=disabled
  -Ddriver_vz=disabled
  -Dsanlock=disabled
  -Dsecdriver_apparmor=disabled
  -Dsecdriver_selinux=disabled
  -Dstorage_sheepdog=disabled
  -Dstorage_vstorage=disabled
  -Ddtrace=disabled
  -Dnumad=disabled
  -Dstorage_zfs=enabled
  -Dstorage_rbd=disabled

groups:
  - id: 115
    name: libvirt
users:
  - id: 115
    name: libvirt
    group: 115
    about: QEMU User
    dir: /var/lib/libvirt
    shell: /bin/false

post-script: |
  chown root:polkitd ${pkgupd_pkgdir}/usr/share/polkit-1/rules.d
  chown 0750 ${pkgupd_pkgdir}/usr/share/polkit-1/rules.d
  chmod 600 ${pkgupd_pkgdir}/etc/libvirt/nwfilter/*.xml \
    ${pkgupd_pkgdir}/etc/libvirt/qemu/networks/default.xml
  chmod 700 ${pkgupd_pkgdir}/etc/libvirt/secrets

integration: |
  usermod -a -G kvm libvirt
