name: Build and Release
on:
  push:
    tags:
      - '[0-9]+'
    branches:
      - '[0-9]+'
jobs:
  generate-image:
    name: Generate Image
    runs-on: self-hosted
    timeout-minutes: 46000
    strategy:
      matrix:
        board:
          - x86_64
    env:
      CACHE_PATH: ${{ secrets.CACHE_PATH }}
      UPDATE_DIR: ${{ secrets.UPDATE_DIR }}
      SERVER: ${{ secrets.UPDATE_URL }}
    steps:
      - uses: actions/checkout@v1


      - name: Setup Environment
        run: |
          VERSION=${GITHUB_REF#refs/*/}
          if [[ "${GITHUB_REF}" =~ "refs/heads/" ]] ; then
            CODENAME="rolling"
          else
            CODENAME="stable"
          fi

          echo "ARCH=${{matrix.board}}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}"   >> $GITHUB_ENV
          echo "CODENAME=${CODENAME}" >> $GITHUB_ENV

          echo "NO CHANGELOG" > files/changelog

      - name: Cleanup build cache
        run: make clean

      - name: Make Pre Installed Apps
        run: make component ELEMENT=boards/common/apps.yml
      
      - name: Make Board Image
        run: |
          for element in image live-config installer updates ; do
            make component ELEMENT=boards/${{matrix.board}}/${element}.yml
          done

      - name: Checkout Release
        run: |
          mkdir -p ${UPDATE_DIR}/${CODENAME}
          make checkout ELEMENT=boards/${{matrix.board}}/installer.yml RELEASE_PATH=${CACHE_PATH}/releases/
          make checkout ELEMENT=boards/${{matrix.board}}/updates.yml   RELEASE_PATH=${UPDATE_DIR}/${CODENAME}/${ARCH}/
          
          cd ${UPDATE_DIR}/${CODENAME}
          sha256sum */*/sysroot.img > SHA256SUMS
      
      - name: Update Metadata
        run: make dump-metadata