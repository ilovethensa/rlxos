name: bootstrap
on: workflow_dispatch

env:
  BUILD_ID: ${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 43800

    steps:
      - uses: actions/checkout@v2

      - id: branch-extract
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

      - id: configure
        name: configuring recipe files
        run: VERSION="${{ steps.branch-extract.outputs.branch }}" ./scripts/configure.py

      - id: bootstrap
        name: bootstrapping packages
        run: |
          VERSION="${{ steps.branch-extract.outputs.branch }}" NO_INPUT=1 ./scripts/bootstrap.sh --bootstrap --rebuild --tar --update-pkgupd --build-id ${{ env.BUILD_ID }}
          mv build/${{ steps.branch-extract.outputs.branch }}/releases/rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}.sfs rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}

      - id: packing
        name: packing build directory
        run: |
          tar -I 'zstd -19' -caf rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}-build.tar.zstd -C build .

      - id: upload
        name: uploading artifact
        uses: actions/upload-artifact@v1
        with:
          name: rlxos ${{ steps.branch-extract.outputs.branch }}  ${{ env.BUILD_ID }}
          path: |
            rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}
            rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}-build.tar.zstd

      - id: release
        name: releasing build
        uses: marvinpinto/action-automatic-releases@latest
        with:
          title: rlxos ${{ steps.branch-extract.outputs.branch }}  ${{ env.BUILD_ID }}
          automatic_release_tag: rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}
          prerelease: false
          draft: false
          files: |
            rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}
            rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}-build.tar.zstd
          repo_token: ${{ secrets.GITHUB_TOKEN }}
