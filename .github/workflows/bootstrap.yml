name: bootstrap
on: workflow_dispatch

env:
  BUILD_ID: ${GITHUB_RUN_NUMBER}

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 43800

    steps:
      - uses: actions/checkout@v2

      - id: branch-extract
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

      - id: configure
        name: configuring recipe files
        run: VERSION="${{ steps.branch-extract.outputs.branch }}" ./scripts/configure.py
        
      - id: sources
        name: copying source files
        run: |
          if [[ ! -d sources ]] ; then
            mkdir -p sources
          fi
          
          mountpoint ./sources || mount --bind /apps.rlxos.dev/sources ./sources

      - id: bootstrap
        name: bootstrapping packages
        run: |
          VERSION="${{ steps.branch-extract.outputs.branch }}" NO_INPUT=1 ./scripts/bootstrap.sh --bootstrap --rebuild --iso --update-pkgupd --build-id ${{ env.BUILD_ID }}

      - id: releasing
        name: uploading release
        run: |
          install -v -D -m 0644 build/${{ steps.branch-extract.outputs.branch }}/releases/rlxos-${{ steps.branch-extract.outputs.branch }}-${{ env.BUILD_ID }}.iso -t /apps.rlxos.dev/${{ steps.branch-extract.outputs.branch }}/releases/

      - id: cleanup
        name: cleaning repository
        if: always()
        run: |
          mountpoint ./sources && umount ./sources
