name: package build
on:
  push:
    paths:
      - "recipes/**"
    branches-ignore:
      - master
env:
  BUILD_ID: ${{ github.run_number }}
jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 43800

    steps:
      - uses: actions/checkout@v2

      - id: branch-extract
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

      - id: configure
        name: configuring recipe files
        run: VERSION="${{ steps.branch-extract.outputs.branch }}" STORAGE_DIR=/storage ./scripts/configure.py

      - id: getting-files
        uses: jitterbit/get-changed-files@v1
      
      - id: build-packages
        run: |
          for changed_file in ${{ steps.getting-files.outputs.all }}; do
            [[ ${changed_file} =~ "recipes/" ]] || continue
            pkgid=$(basename $(echo $changed_file | sed 's|.yml||g'))
            echo "compiling ${pkgid}"
            VERSION="${{ steps.branch-extract.outputs.branch }}" \
            NO_INPUT=1 \
            STORAGE_DIR=/storage \
            BASEDIR=/root/server/rlxos/ \
            ./scripts/exec.sh pkgupd co ${pkgid} --force
          done
