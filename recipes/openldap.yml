id: openldap
version: 2.6.1
about: |
  Open source implementation of the Lightweight Directory Access Protocol

depends:
  runtime:
    - cyrus-sasl

groups:
  - id: 83
    name: ldap
users:
  - id: 83
    group: 83
    name: ldap
    about: OpenLDAP Daemon Owner
    dir: /var/lib/openldap
    shell: /bin/false
  
sources:
  - https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-{{version}}.tgz
  - https://www.linuxfromscratch.org/patches/blfs/svn/openldap-{{version}}-consolidated-2.patch

build-dir: openldap-{{version}}
pre-script: |
  patch -Np1 -i ../openldap-{{version}}-consolidated-2.patch
  sed -i -e "s|EnvironmentFile.*|EnvironmentFile=-/etc/conf.d/slapd|" -e "s/slapd -d 0/\0 -u ldap -g ldap/" servers/slapd/slapd.service
  autoconf
    
configure: >
  --disable-static
  --enable-versioning
  --with-tls=openssl
  --with-cyrus=sasl
  --enable-dynamic
  --enable-crypt
  --enable-spasswd
  --enable-slapd
  --enable-modules
  --enable-rlookups
  --enable-backends=mod
  --disable-ndb
  --disable-sql
  --disable-wt
  --enable-overlays=mod

post-script: |
  sed -e "s/\.la/.so/" -i ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}{,.default}
  install -v -dm700 -o 83 -g 83 ${pkgupd_pkgdir}/var/lib/openldap
  install -v -dm700 -o 83 -g 83 ${pkgupd_pkgdir}/etc/openldap/slapd.d
  chmod -v 640 ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}
  chown -v root:83 ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}
