id: openldap
version: 2.6.1
release: 1
about: |
  Open source implementation of the Lightweight Directory Access Protocol

depends:
  runtime:
    - cyrus-sasl

groups:
  - id: 83
    name: ldap
users:
  - id: 83
    group: 83
    name: ldap
    about: OpenLDAP Daemon Owner
    dir: /var/lib/openldap
    shell: /bin/false
  
sources:
  - https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-{{version}}.tgz

pre-script: |
  # change permission from 0644 to 0755
  sed -i 's|-m 644 $(LIBRARY)|-m 755 $(LIBRARY)|' libraries/{liblber,libldap}/Makefile.in

  # change rundir to /run/openldap
  sed -i 's|#define LDAPI_SOCK LDAP_RUNDIR LDAP_DIRSEP "run" LDAP_DIRSEP "ldapi"|#define LDAPI_SOCK LDAP_DIRSEP "run" LDAP_DIRSEP "openldap" LDAP_DIRSEP "ldapi"|' include/ldap_defaults.h
  sed -i 's|%LOCALSTATEDIR%/run|/run/openldap|' servers/slapd/slapd.{conf,ldif}
  sed -i 's|-$(MKDIR) $(DESTDIR)$(localstatedir)/run|-$(MKDIR) $(DESTDIR)/run/openldap|' servers/slapd/Makefile.in

  sed -i -e "s|EnvironmentFile.*|EnvironmentFile=-/etc/conf.d/slapd|" -e "s/slapd -d 0/\0 -u ldap -g ldap/" servers/slapd/slapd.service
  autoconf
    
autoconf-dir: true
configure: >
  --disable-static
  --enable-versioning=yes
  --disable-debug
  --with-tls=openssl
  --with-cyrus-sasl
  --enable-dynamic
  --enable-crypt
  --enable-spasswd
  --enable-slapd
  --enable-modules
  --enable-rlookups
  --enable-backends=mod
  --disable-ndb
  --disable-sql
  --disable-wt
  --enable-overlays=mod

post-script: |
  ln -s ../lib/slapd ${pkgupd_pkgdir}/usr/bin/slapd

  sed -e "s/\.la/.so/" -i ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}{,.default}
  install -v -dm700 -o 83 -g 83 ${pkgupd_pkgdir}/var/lib/openldap
  install -v -dm700 -o 83 -g 83 ${pkgupd_pkgdir}/etc/openldap/slapd.d
  chmod -v 640 ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}
  chown -v root:83 ${pkgupd_pkgdir}/etc/openldap/slapd.{conf,ldif}

split:
  - into: libldap
    about: Lightweight Directory Access Protocol (LDAP) client libraries
    files:
      - usr/lib/libldap.so
      - usr/lib/libldap.so.2.0.200
      - usr/lib/openldap/syncprov.so.2.0.200
      - usr/lib/openldap/ppolicy.so.2.0.200
      - usr/lib/openldap/back_sock.so.2
      - usr/lib/openldap/autoca.so.2
      - usr/lib/openldap/back_ldap.so.2
      - usr/lib/openldap/memberof.so.2.0.200
      - usr/lib/openldap/back_ldap.so.2.0.200
      - usr/lib/openldap/back_perl.so.2.0.200
      - usr/lib/openldap/auditlog.so.2
      - usr/lib/openldap/dds.so.2
      - usr/lib/openldap/pcache.so.2
      - usr/lib/openldap/auditlog.so
      - usr/lib/openldap/valsort.so.2.0.200
      - usr/lib/openldap/back_passwd.so.2
      - usr/lib/openldap/accesslog.so.2.0.200
      - usr/lib/openldap/retcode.so
      - usr/lib/openldap/homedir.so.2
      - usr/lib/openldap/remoteauth.so.2
      - usr/lib/openldap/ppolicy.so
      - usr/lib/openldap/seqmod.so.2.0.200
      - usr/lib/openldap/memberof.so
      - usr/lib/openldap/translucent.so.2
      - usr/lib/openldap/valsort.so.2
      - usr/lib/openldap/back_relay.so
      - usr/lib/openldap/rwm.so
      - usr/lib/openldap/sssvlv.so
      - usr/lib/openldap/back_dnssrv.so.2.0.200
      - usr/lib/openldap/back_null.so.2.0.200
      - usr/lib/openldap/syncprov.so.2
      - usr/lib/openldap/back_meta.so.2.0.200
      - usr/lib/openldap/constraint.so
      - usr/lib/openldap/homedir.so
      - usr/lib/openldap/dds.so.2.0.200
      - usr/lib/openldap/back_asyncmeta.so.2.0.200
      - usr/lib/openldap/retcode.so.2.0.200
      - usr/lib/openldap/dynlist.so
      - usr/lib/openldap/otp.so.2
      - usr/lib/openldap/remoteauth.so
      - usr/lib/openldap/pcache.so
      - usr/lib/openldap/unique.so
      - usr/lib/openldap/translucent.so.2.0.200
      - usr/lib/openldap/accesslog.so.2
      - usr/lib/openldap/back_asyncmeta.so
      - usr/lib/openldap/back_ldap.so
      - usr/lib/openldap/seqmod.so.2
      - usr/lib/openldap/accesslog.so
      - usr/lib/openldap/refint.so.2.0.200
      - usr/lib/openldap/rwm.so.2
      - usr/lib/openldap/back_mdb.so
      - usr/lib/openldap/back_perl.so.2
      - usr/lib/openldap/dds.so
      - usr/lib/openldap/remoteauth.so.2.0.200
      - usr/lib/openldap/refint.so
      - usr/lib/openldap/back_null.so
      - usr/lib/openldap/back_asyncmeta.so.2
      - usr/lib/openldap/dyngroup.so.2
      - usr/lib/openldap/deref.so
      - usr/lib/openldap/refint.so.2
      - usr/lib/openldap/dyngroup.so
      - usr/lib/openldap/dynlist.so.2
      - usr/lib/openldap/back_meta.so.2
      - usr/lib/openldap/sssvlv.so.2.0.200
      - usr/lib/openldap/valsort.so
      - usr/lib/openldap/collect.so.2.0.200
      - usr/lib/openldap/autoca.so
      - usr/lib/openldap/otp.so.2.0.200
      - usr/lib/openldap/auditlog.so.2.0.200
      - usr/lib/openldap/back_sock.so
      - usr/lib/openldap/syncprov.so
      - usr/lib/openldap/back_null.so.2
      - usr/lib/openldap/back_relay.so.2
      - usr/lib/openldap/sssvlv.so.2
      - usr/lib/openldap/deref.so.2
      - usr/lib/openldap/back_dnssrv.so.2
      - usr/lib/openldap/unique.so.2
      - usr/lib/openldap/deref.so.2.0.200
      - usr/lib/openldap/memberof.so.2
      - usr/lib/openldap/unique.so.2.0.200
      - usr/lib/openldap/seqmod.so
      - usr/lib/openldap/otp.so
      - usr/lib/openldap/collect.so.2
      - usr/lib/openldap/autoca.so.2.0.200
      - usr/lib/openldap/ppolicy.so.2
      - usr/lib/openldap/retcode.so.2
      - usr/lib/openldap/dyngroup.so.2.0.200
      - usr/lib/openldap/constraint.so.2.0.200
      - usr/lib/openldap/pcache.so.2.0.200
      - usr/lib/openldap/constraint.so.2
      - usr/lib/openldap/homedir.so.2.0.200
      - usr/lib/openldap/dynlist.so.2.0.200
      - usr/lib/openldap/back_sock.so.2.0.200
      - usr/lib/openldap/back_perl.so
      - usr/lib/openldap/collect.so
      - usr/lib/openldap/back_dnssrv.so
      - usr/lib/openldap/back_passwd.so
      - usr/lib/openldap/back_mdb.so.2
      - usr/lib/openldap/translucent.so
      - usr/lib/openldap/rwm.so.2.0.200
      - usr/lib/openldap/back_passwd.so.2.0.200
      - usr/lib/openldap/back_meta.so
      - usr/lib/openldap/back_relay.so.2.0.200
      - usr/lib/openldap/back_mdb.so.2.0.200
      - usr/lib/liblber.so.2
      - usr/lib/libldap.so.2
      - usr/lib/pkgconfig/lber.pc
      - usr/lib/pkgconfig/ldap.pc
      - usr/lib/liblber.so.2.0.200
      - usr/lib/liblber.so
