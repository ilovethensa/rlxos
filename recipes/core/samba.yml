id: samba
version: 4.16.0
release: 2
about: |
  Package provides file and print services to SMB/CIFS clients and Windows networking to Linux clients

depends:
  runtime:
    - gnutls
    - jansson
    - libtirpc
    - lmdb
    - rpcsvc-proto
    - fuse
    - gpgme
    - libtasn1
    - libxslt
    - pam
    - perl-parse-yapp
    - perl-json
    - cups
    - libldap
  buildtime:
    - py-pip
    - openldap

sources:
  - https://www.samba.org/ftp/samba/stable/samba-{{version}}.tar.gz

build-dir: samba-{{version}}
script: |
  python3 -m venv pyenv
  ./pyenv/bin/pip3 install cryptography pyasn1 iso8601

  PYTHON=$PWD/pyenv/bin/python3 \
  CPPFLAGS="-I/usr/lib/tirpc" \
    LDFLAGS="-ltirpc" \
  ./configure --prefix=/usr \
      --sysconfdir=/etc \
      --sbindir=/usr/bin \
      --libdir=/usr/lib \
      --libexecdir=/usr/lib/samba \
      --localstatedir=/var \
      --with-configdir=/etc/samba \
      --with-lockdir=/var/cache/samba \
      --with-sockets-dir=/run/samba \
      --with-piddir=/run \
      --with-pammodulesdir=/usr/lib/security \
      --enable-fhs \
      --without-ad-dc \
      --enable-selftest
  make

  sed '1s@^.*$@#!/usr/bin/python3@' \
    -i ./bin/default/source4/scripting/bin/samba-gpupdate.inst

  make DESTDIR=${pkgupd_pkgdir} install

  install -v -m644 examples/smb.conf.default ${pkgupd_pkgdir}/etc/samba
  sed -e "s;log file =.*;log file = /var/log/samba/%m.log;" \
    -e "s;path = /usr/spool/samba;path = /var/spool/samba;" \
    -i ${pkgupd_pkgdir}/etc/samba/smb.conf.default
    
  mkdir -pv ${pkgupd_pkgdir}/etc/openldap/schema
  cp examples/LDAP/README ${pkgupd_pkgdir}/etc/openldap/sschema/README.LDAP
  cp examples/LDAP/samba* ${pkgupd_pkgdir}/etc/openldap/sschema/
  cp examples/LDAP/{get*,ol*} ${pkgupd_pkgdir}/etc/openldap/sschema/

  install -vdm 755 ${pkgupd_pkgdir}/usr/lib/cups/backend
  ln -sf -v /usr/bin/smbspool ${pkgupd_pkgdir}/usr/lib/cups/backend/smb
