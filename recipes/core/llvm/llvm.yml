id: llvm
version: 14.0.6
about: |
  A collection of modular and reusable compiler and toolchain technologies

depends:
  buildtime:
    - cmake

sources:
  - https://github.com/llvm/llvm-project/releases/download/llvmorg-{{version}}/llvm-{{version}}.src.tar.xz
  - https://github.com/llvm/llvm-project/releases/download/llvmorg-{{version}}/clang-{{version}}.src.tar.xz
  - https://github.com/llvm/llvm-project/releases/download/llvmorg-{{version}}/compiler-rt-{{version}}.src.tar.xz

build-dir: llvm-{{version}}.src
pre-script: |
  ls ../
  mv ../clang-{{version}}.src tools/clang
  mv ../compiler-rt-{{version}}.src projects/compiler-rt

  grep -rl "#!.*python" | xargs sed -i "1s/python$/python3/"

configure: >
  -DCMAKE_LIBEXECDIR=/usr/lib
  -DLLVM_ENABLE_FFI=ON
  -DCMAKE_BUILD_TYPE=Release
  -DLLVM_BUILD_LLVM_DYLIB=ON
  -DLLVM_LINK_LLVM_DYLIB=ON
  -DLLVM_ENABLE_RTTI=ON
  -DLLVM_TARGETS_TO_BUILD="X86;AMDGPU;BPF"
  -DLLVM_BUILD_TESTS=ON
  -DLLVM_INCLUDE_BENCHMARKS=OFF
  -DLLVM_BINUTILS_INCDIR=/usr/include
  -Wno-dev -G Ninja

split:
  - into: libllvm
    about: llvm runtime library
    files:
      - usr/lib/libLTO.so.14
      - usr/lib/libLTO.so
      - usr/lib/LLVMgold.so
      - usr/lib/libclang-cpp.so.14
      - usr/lib/libclang-cpp.so
      - usr/lib/libclang.so.14.0.6
      - usr/lib/libclang.so.13
      - usr/lib/libclang.so
      - usr/lib/libLLVM-14.so
      - usr/lib/libLLVM.so
      - usr/lib/libRemarks.so.14
      - usr/lib/libRemarks.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.ubsan_minimal-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.ubsan_standalone-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.hwasan-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.hwasan_aliases-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.tsan-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.scudo-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.scudo_minimal-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.scudo_standalone-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.asan-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.memprof-x86_64.so
      - usr/lib/clang/{{version}}/lib/linux/libclang_rt.dyndd-x86_64.so
