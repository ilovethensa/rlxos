id: qt
version: 5.15.4
about: |
  Cross-platform application framework

depends:
  runtime:
    - dbus
    - openssl
    - gdk-pixbuf
    - libepoxy
    - libmng
    - libxkbcommon
    - harfbuzz
    - xcb-util-wm
    - xcb-util-image
    - xcb-util-keysyms
    - xcb-util-renderutil
    - desktop-file-utils
    - libxcb
    - sqlite
    - fontconfig
    - which
    - nodejs
    - nss
    - pcre2
    - python
    - alsa-lib
    - pulseaudio
    - ffmpeg
    - icu
    - cups

build-dir: qt-everywhere-src-{{version}}
sources:
  - https://download.qt.io/archive/qt/5.15/{{version}}/single/qt-everywhere-opensource-src-{{version}}.tar.xz
script: |

  sed -i "/utility/a #include <limits>"     qtbase/src/corelib/global/qglobal.h
  sed -i "/string/a #include <limits>"      qtbase/src/corelib/global/qfloat16.h
  sed -i "/qbytearray/a #include <limits>"  qtbase/src/corelib/text/qbytearraymatcher.h
  sed -i "/type_traits/a #include <limits>" qtdeclarative/src/qmldebug/qqmlprofilerevent_p.h

  ./configure -prefix /usr \
    -sysconfdir /etc/xdg \
    -confirm-license -opensource \
    -dbus-linked \
    -openssl-linked \
    -system-harfbuzz \
    -system-sqlite \
    -nomake examples \
    -no-rpath \
    -syslog \
    -journald

  make

  make install INSTALL_ROOT=${pkgupd_pkgdir}

  find ${pkgupd_pkgdir}/ -name \*.prl \
    -exec sed -i -e "/^QMAKE_PRL_BUILD_DIR/d" {} \;

  install -v -D -m 644 qttools/src/assistant/assistant/images/assistant-128.png \
    $pkgupd_pkgdir/usr/share/pixmaps/assistant-qt5.png
  
  install -v -D -m 644 qttools/src/designer/src/designer/images/designer.png \
    $pkgupd_pkgdir/usr/share/pixmaps/designer-qt5.png
  
  install -v -Dm644 qttools/src/linguist/linguist/images/icons/linguist-128-32.png \
              ${pkgupd_pkgdir}/usr/share/pixmaps/linguist-qt5.png
  
  install -v -Dm644 qttools/src/qdbus/qdbusviewer/images/qdbusviewer-128.png \
              ${pkgupd_pkgdir}/usr/share/pixmaps/qdbusviewer-qt5.png

  install -v -D ${FILES_DIR}/*.desktop -t ${pkgupd_pkgdir}/usr/share/applications/
