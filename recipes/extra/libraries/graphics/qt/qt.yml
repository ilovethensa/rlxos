id: qt
version: 5.15.4
about: |
  Cross-platform application framework

depends:
  runtime:
    - xorg-libs
    - alsa-lib
    - make-ca
    - cups
    - glib
    - gst-plugins-base
    - harfbuzz-icu
    - jasper
    - libjpeg-turbo
    - libmng
    - libpng
    - libtiff
    - libwebp
    - libxkbcommon
    - mesa
    - mtdev
    - pcre2
    - sqlite
    - wayland
    - xcb-util-image
    - xcb-util-keysyms
    - xcb-util-renderutil
    - xcb-util-wm
    - libinput
    - ibus
    - ffmpeg
    - pulseaudio
    - nodejs
    - nss
    - libxslt
    - opus
    - pipewire
    - poppler
    - kerberos-v5
    - libevent

build-dir: qt-everywhere-src-{{version}}
sources:
  - https://download.qt.io/archive/qt/5.15/{{version}}/single/qt-everywhere-opensource-src-{{version}}.tar.xz
script: |
  patch -Np1 -i ${FILES_DIR}/qt-everywhere-opensource-src-5.15.4-kf5-1.patch

  ./configure -prefix /usr \
    -archdatadir /usr/lib/qt5 \
    -bindir /usr/bin \
    -plugindir /usr/lib/qt5/plugins \
    -importdir /usr/lib/qt5/imports \
    -headerdir /usr/include/qt5 \
    -datadir /usr/share/qt5 \
    -docdir /usr/share/doc/qt5 \
    -translationdir /usr/share/qt5/translations \
    -examplesdir /usr/share/doc/qt5/examples \
    -sysconfdir /etc/xdg \
    -confirm-license -opensource \
    -dbus-linked \
    -openssl-linked \
    -system-harfbuzz \
    -system-sqlite \
    -nomake examples \
    -system-ffmpeg \
    -webengine-icu \
    -no-rpath \
    -syslog \
    -journald

  make

  make install INSTALL_ROOT=${pkgupd_pkgdir}

  find ${pkgupd_pkgdir}/ -name \*.prl \
    -exec sed -i -e "/^QMAKE_PRL_BUILD_DIR/d" {} \;

  install -v -D -m 644 qttools/src/assistant/assistant/images/assistant-128.png \
    $pkgupd_pkgdir/usr/share/pixmaps/assistant-qt5.png
  
  install -v -D -m 644 qttools/src/designer/src/designer/images/designer.png \
    $pkgupd_pkgdir/usr/share/pixmaps/designer-qt5.png
  
  install -v -Dm644 qttools/src/linguist/linguist/images/icons/linguist-128-32.png \
              ${pkgupd_pkgdir}/usr/share/pixmaps/linguist-qt5.png
  
  install -v -Dm644 qttools/src/qdbus/qdbusviewer/images/qdbusviewer-128.png \
              ${pkgupd_pkgdir}/usr/share/pixmaps/qdbusviewer-qt5.png

  install -v -D ${FILES_DIR}/*.desktop -t ${pkgupd_pkgdir}/usr/share/applications/

  for file in moc uic rcc qmake lconvert lrelease lupdate; do
    ln -sfvn $file ${pkgupd_pkgdir}/usr/bin/$file-qt5
  done

  mkdir -p ${pkgupd_pkgdir}/etc/ld.so.conf.d/
  echo "/usr/lib/qt5" > ${pkgupd_pkgdir}/etc/ld.so.conf.d/qt5.conf