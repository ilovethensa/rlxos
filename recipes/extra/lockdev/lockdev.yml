id: lockdev
version: 1.0.3
about: Run-time shared library for locking devices, using _both_ FSSTND and SVr4 methods
depends:
  runtime:
    - glibc
    - systemd
variables:
  patch: 1.6
sources:
  - http://ftp.debian.org/debian/pool/main/l/{{id}}/{{id}}_{{version}}.orig.tar.gz
  - lockdev_{{version}}-{{patch}}.diff.compressed::http://ftp.debian.org/debian/pool/main/l/{{id}}/{{id}}_{{version}}-{{patch}}.diff.gz
pre-script: |
  mv ../{{id}}_{{version}}-{{patch}}.diff.{compressed,gz}
  gzip -d ../{{id}}_{{version}}-{{patch}}.diff.gz
  patch -p1 -i ../{{id}}_{{version}}-{{patch}}.diff

  sed -i "s|CFLAGS	= -g|CFLAGS	= -g -fPIC|" Makefile
  patch -p1 -i ${FILES_DIR}/build.patch
  patch -p1 -i ${FILES_DIR}/gcc-4.7.patch

  make CFLAGS="${CFLAGS:-} -D_PATH_LOCK=\\\"/run/lock/lockdev\\\" -fPIC"
  make basedir=${pkgupd_pkgdir}/usr install

  install -dm0755 "${pkgupd_pkgdir}/usr/lib/tmpfiles.d"
  echo 'd /run/lock/lockdev 0775 root lock -' > "$pkgupd_pkgdir/usr/lib/tmpfiles.d/{{id}}.conf"
