id: lxd
version: 4.19
about: Daemon based on liblxc offering a REST API to manage containers
depends:
  runtime:
    - dnsmasq
    - dqlite
    - iptables
    - libuv
    - lxc
    - lxcfs
    - squashfs-tools
  buildtime:
    - go
    - libseccomp
    - systemd
    - tcl
sources:
  - https://linuxcontainers.org/downloads/lxd/lxd-{{version}}.tar.gz

build-dir: lxd-{{version}}
pre-script: |
  mkdir bin
  echo "verifing modules"
  go mod verify

  echo "modules verified"

environ:
  - GOFLAGS="-buildmode=pie -trimpath"
  - CGO_LDFLAGS_ALLOW="-Wl,-z,now"
script: |
  for tool in lxd lxc lxd-p2c fuidshift ; do
    go build -v -tags "libsqlite3" -o bin/ ./${tool}/...
    install -v -p -D -m 0755 bin/${tool} ${pkgupd_pkgdir}/usr/bin/${tool}
  done

  install -v -D -m 0644 ${FILES}/lxd/lxd.{service,socket} -t ${pkgupd_pkgdir}/usr/lib/systemd/system/
  install -v -d -m 0700 ${pkgupd_pkgdir}/var/log/lxd