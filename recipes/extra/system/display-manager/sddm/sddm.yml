id: sddm
version: 0.19.0
about: QML based X11 and Wayland display manager
depends:
  runtime:
    - pcre2
    - kerberos-v5
    - qt
    - ttf-noto
    - xorg-server
    - xauth
  buildtime:
    - extra-cmake-modules

users:
  - id: 64
    name: sddm
    about: SDDM Daemon
    shell: /bin/false
    dir: /var/lib/sddm
    group: 64
groups:
  - id: 64
    name: sddm

sources:
  - sddm-{{version}}.tar.gz::https://github.com/{{id}}/{{id}}/archive/v{{version}}.tar.gz
  - sddm-fix-race-pre.patch::https://github.com/sddm/sddm/commit/68cc9e31.patch
  - sddm-fix-race.patch::https://patch-diff.githubusercontent.com/raw/sddm/sddm/pull/1324.patch
  - sddm-desktop-session.patch::https://github.com/sddm/sddm/commit/5fd5ed27.patch

build-dir: sddm-{{version}}
pre-script: |
  patch -p1 < ${FILES_DIR}/pam-faillock.patch
  patch -p1 < ../sddm-fix-race-pre.patch
  patch -p1 < ../sddm-fix-race.patch
  patch -p1 < ../sddm-desktop-session.patch
  patch -p1 < ${FILES_DIR}/build-fix.patch

configure: >
  -DDBUS_CONFIG_DIR=/usr/share/dbus-1/system.d
  -DDBUS_CONFIG_FILENAME=sddm_org.freedesktop.DisplayManager.conf
  -DBUILD_MAN_PAGES=OFF
  -DUID_MAX=60513

post-script: |
  install -d "$pkgupd_pkgdir"/usr/lib/sddm/sddm.conf.d
  "$pkgupd_pkgdir"/usr/bin/sddm --example-config > "$pkgupd_pkgdir"/usr/lib/sddm/sddm.conf.d/default.conf
  sed -r 's|DefaultPath=.*|DefaultPath=/usr/local/sbin:/usr/local/bin:/usr/bin|g' -i "$pkgupd_pkgdir"/usr/lib/sddm/sddm.conf.d/default.conf
  sed -e "/^InputMethod/s/qtvirtualkeyboard//" -i "$pkgupd_pkgdir"/usr/lib/sddm/sddm.conf.d/default.conf