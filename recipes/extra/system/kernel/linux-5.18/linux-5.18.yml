id: linux-5.18
version: 5.18.3
release: 2
about: |
  Linux kernel, modules and headers

sources:
  - https://www.kernel.org/pub/linux/kernel/v5.x/linux-{{version}}.tar.xz

depends:
  buildtime:
    - coreutils
    - kmod
    - bc
    - cpio
    - xz
    - xmlto
    - tar
    - libelf
    - zstd

script: |
  make mrproper

  cp ${FILES_DIR}/config ./.config

  sed '/^CONFIG_LOCALVERSION=/d' -i .config
	echo 'CONFIG_LOCALVERSION="-{{version}}"' >> .config

  mkdir -p ${pkgupd_pkgdir}/{boot,lib}
  ln -sv ../lib/modules ${pkgupd_pkgdir}/boot/modules

  make olddefconfig

  make bzImage modules
  make INSTALL_MOD_PATH=${pkgupd_pkgdir} \
       INSTALL_MOD_STRIP=1 \
       modules_install

  cp ./.config ${FILES_DIR}/config

  cp arch/x86/boot/bzImage ${pkgupd_pkgdir}/boot/vmlinuz-{{version}}-rlxos      
  
  rm ${pkgupd_pkgdir}/boot/modules/{{version}}-rlxos/{build,source}
  rm ${pkgupd_pkgdir}/boot/modules
  mv ${pkgupd_pkgdir}/{lib,boot}/modules
  rmdir ${pkgupd_pkgdir}/lib
