id: mariadb
version: 10.6.8
release: 1
about: A community-developed fork and a drop-in replacement for the MySQL relational database management system
depends:
  runtime:
    - libevent
    - libboost
    - libxml2
    - pam
    - kerberos-v5
    - pcre2
  buildtime:
    - cmake
    - boost
sources:
  - https://rsync.osuosl.org/pub/mariadb/mariadb-{{version}}/source/mariadb-{{version}}.tar.gz

groups:
  - id: 40
    name: mysql
users:
  - id: 40
    name: mysql
    about: MySQL Server
    group: 40
    shell: /bin/false
    dir: /srv/mysql

pre-script: patch -Np1 -i ${FILES_DIR}/mariadb-{{version}}-openssl3_fix-1.patch

configure: >
  -DINSTALL_DOCDIR=share/doc/{{id}}-{{version}}
  -DCMAKE_BUILD_TYPE=Release
  -DINSTALL_DOCREADMEDIR=share/doc/{{id}}-{{version}}
  -DINSTALL_MANDIR=share/man
  -DINSTALL_MYSQLSHAREDIR=share/mysql
  -DINSTALL_MYSQLTESTDIR=share/mysql/test
  -DINSTALL_PLUGINDIR=lib/mysql/plugin
  -DINSTALL_SBINDIR=bin
  -DINSTALL_SCRIPTDIR=bin
  -DSKIP_TESTS=ON
  -DINSTALL_INCLUDEDIR=include/mysql
  -DINSTALL_SQLBENCHDIR=share/mysql/bench
  -DINSTALL_SUPPORTFILESDIR=share/mysql
  -DMYSQL_DATADIR=/srv/mysql
  -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock
  -DWITH_EXTRA_CHARSETS=complex
  -DWITH_EMBEDDED_SERVER=ON
  -DSKIP_TESTS=ON
  -DTOKUDB_OK=0
  -DINSTALL_SYSTEMD_UNITDIR=/usr/lib/systemd/system/
  -DINSTALL_SYSTEMD_SYSUSERSDIR=/usr/lib/sysusers.d/
  -DINSTALL_SYSTEMD_TMPFILEDIR=/usr/lib/tmpfiles.d/
  -DENABLED_LOCAL_INFILE=ON
  -DPLUGIN_EXAMPLE=NO
  -DPLUGIN_FEDERATED=NO
  -DPLUGIN_FEEDBACK=NO
  -DWITH_SSL=system
  -DWITH_SYSTEMD=yes
  -DWITH_UNIT_TESTS=OFF

post-script: |
  install -v -D -m 644 ${FILES_DIR}/default.cnf -t ${pkgupd_pkgdir}/etc/mysql
