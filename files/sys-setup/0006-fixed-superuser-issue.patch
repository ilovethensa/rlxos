From 1fa47ae7e0fac8b89c963e33c84e1ece068c7fed Mon Sep 17 00:00:00 2001
From: itsmanjeet <itsmanjeet1998@gmail.com>
Date: Wed, 17 Nov 2021 20:27:57 +0530
Subject: [PATCH] fixed superuser issue

---
 app/app.go          | 15 +++++++++++++++
 firstlogin/setup.go | 11 +++++++++--
 firstlogin/user.go  |  3 ++-
 3 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/app/app.go b/app/app.go
index 6eacd48..ff46f5f 100644
--- a/app/app.go
+++ b/app/app.go
@@ -4,6 +4,8 @@ import (
 	"errors"
 	"log"
 	"os"
+	"os/exec"
+	"os/user"
 
 	"github.com/gotk3/gotk3/gdk"
 	"github.com/gotk3/gotk3/gtk"
@@ -188,3 +190,16 @@ func (app *App) GetListText(row *gtk.ListBoxRow) (string, error) {
 
 	return label.GetText()
 }
+
+func (app *App) ExecAsUser(uid string, cmd ...string) error {
+	u, err := user.LookupId(uid)
+	if err != nil {
+		return err
+	}
+	command := []string{
+		"pkexec", "--username", u.Username,
+	}
+
+	command = append(command, cmd...)
+	return exec.Command(command[0], command[1:]...).Run()
+}
diff --git a/firstlogin/setup.go b/firstlogin/setup.go
index 0c7e88d..cebbed7 100644
--- a/firstlogin/setup.go
+++ b/firstlogin/setup.go
@@ -156,8 +156,15 @@ func Setup(win *gtk.Assistant) error {
 			if err != nil {
 				log.Println("Failed to remove autologin file, ", err.Error())
 			}
-			if err := exec.Command("xfce4-session-logout", "--logout").Run(); err != nil {
-				log.Println("Failed to do execute logout, ", err)
+			pkexecUid := os.Getenv("PKEXEC_UID")
+			if len(pkexecUid) == 0 {
+				if err := exec.Command("xfce4-session-logout", "--logout").Run(); err != nil {
+					log.Println("Failed to do execute logout, ", err)
+				}
+			} else {
+				if err := f.ExecAsUser(pkexecUid, "xfce4-session-logout", "--logout"); err != nil {
+					log.Println("Failed to execute logout", err)
+				}
 			}
 
 		} else {
diff --git a/firstlogin/user.go b/firstlogin/user.go
index 56c881a..e9c05fc 100644
--- a/firstlogin/user.go
+++ b/firstlogin/user.go
@@ -56,7 +56,7 @@ func (f *FirstLogin) createUser(userid, passwd string) {
 			showError(err.Error())
 			return
 		}
-		if err := exec.Command("sh", "-c", "echo -e \""+passwd+"\n"+passwd+"\" | passwd " + userid).Run(); err != nil {
+		if err := exec.Command("sh", "-c", "echo -e \""+passwd+"\n"+passwd+"\" | passwd "+userid).Run(); err != nil {
 			showError(err.Error())
 			return
 		}
@@ -66,6 +66,7 @@ func (f *FirstLogin) createUser(userid, passwd string) {
 
 	glib.IdleAdd(func() {
 		f.Window.SetPageComplete(f.UserAccountPage, true)
+		f.Window.SetCurrentPage(3)
 	})
 
 }
-- 
2.32.0

