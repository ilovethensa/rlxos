From 95530a0c09f3daeca9798a3838ea2d544d076fdd Mon Sep 17 00:00:00 2001
From: itsmanjeet <itsmanjeet1998@gmail.com>
Date: Sat, 30 Oct 2021 23:03:57 +0530
Subject: [PATCH] fixed various issues

---
 libpkgupd/builder.cc | 2 +-
 libpkgupd/builder.hh | 6 ++++--
 libpkgupd/image.cc   | 7 ++++++-
 3 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/libpkgupd/builder.cc b/libpkgupd/builder.cc
index 23e2826..99be689 100644
--- a/libpkgupd/builder.cc
+++ b/libpkgupd/builder.cc
@@ -163,7 +163,7 @@ bool builder::_build(std::shared_ptr<recipe::package> package) {
         if (package->pack() == "rlx") {
             PROCESS("packaging rlx archive");
             archive_ = std::make_shared<tar>(pkgfile);
-        } else if (package->pack() == "image") {
+        } else if (package->pack() == "app") {
             PROCESS("packaging app image");
             archive_ = std::make_shared<image>(pkgfile);
         } else {
diff --git a/libpkgupd/builder.hh b/libpkgupd/builder.hh
index 74c7b64..999d42c 100644
--- a/libpkgupd/builder.hh
+++ b/libpkgupd/builder.hh
@@ -63,7 +63,9 @@ class builder : public object {
         }
         for (auto const &pkg : recipe_->packages())
             if (!_build(pkg)) {
-                std::filesystem::remove_all(_work_dir);
+                if (!pkg->parent()->split()) {
+                    std::filesystem::remove_all(_work_dir);
+                  }
                 return false;
             }
 
@@ -72,4 +74,4 @@ class builder : public object {
 };
 }  // namespace rlxos::libpkgupd
 
-#endif
\ No newline at end of file
+#endif
diff --git a/libpkgupd/image.cc b/libpkgupd/image.cc
index 19ea3a1..82ea6ef 100644
--- a/libpkgupd/image.cc
+++ b/libpkgupd/image.cc
@@ -120,7 +120,12 @@ bool image::compress(std::string const& srcdir, std::shared_ptr<pkginfo> const&
             continue;
         }
         DEBUG("copying " << i);
-        std::filesystem::copy_file(i, libdir / std::filesystem::path(i).filename());
+        std::error_code err;
+        std::filesystem::copy_file(i, libdir / std::filesystem::path(i).filename(), err);
+        if (err) {
+            _error = err.message();
+            return false;
+        }
     }
 
     std::shared_ptr<recipe::package> _pkg = std::dynamic_pointer_cast<recipe::package>(info);
-- 
2.32.0

