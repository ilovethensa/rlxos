From 1cde729c1edc62ae445d4a1e5102fb8d5a5965d9 Mon Sep 17 00:00:00 2001
From: itsmanjeet <itsmanjeet1998@gmail.com>
Date: Wed, 6 Oct 2021 23:30:16 +0530
Subject: [PATCH] fixed extraction issue on docker

---
 libpkgupd/archive.cc | 8 ++++----
 libpkgupd/builder.cc | 2 +-
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/libpkgupd/archive.cc b/libpkgupd/archive.cc
index 3f59681..cffa7ab 100644
--- a/libpkgupd/archive.cc
+++ b/libpkgupd/archive.cc
@@ -20,7 +20,7 @@ archive::package::package(YAML::Node const &data, std::string const &file) {
 
 std::tuple<int, std::string> archive::getdata(std::string const &filepath) {
     std::string cmd = _archive_tool;
-    cmd += " --zstd -O -xf " + _pkgfile + " " + filepath;
+    cmd += " --zstd -O -xPf " + _pkgfile + " " + filepath;
 
     auto [status, output] = exec().output(cmd);
     if (status != 0) {
@@ -52,7 +52,7 @@ std::shared_ptr<archive::package> archive::info() {
 
 std::vector<std::string> archive::list() {
     std::string cmd = _archive_tool;
-    cmd += " --zstd -tf " + _pkgfile;
+    cmd += " --zstd -tPf " + _pkgfile;
 
     auto [status, output] = exec().output(cmd);
     if (status != 0) {
@@ -121,7 +121,7 @@ bool archive::compress(std::string const &srcdir, std::shared_ptr<pkginfo> const
 
     std::string command = _archive_tool;
 
-    command += " --zstd -cf " + _pkgfile + " -C " + srcdir + " . ";
+    command += " --zstd -cPf " + _pkgfile + " -C " + srcdir + " . ";
     if (exec().execute(command) != 0) {
         _error = "failed to execute command for compression '" + command + "'";
         return false;
@@ -138,7 +138,7 @@ bool archive::extract(std::string const &outdir) {
 
     std::string cmd = _archive_tool;
 
-    cmd += " --zstd --exclude './info' -xhpf " + _pkgfile + " -C " + outdir;
+    cmd += " --zstd --exclude './info' -xPhpf " + _pkgfile + " -C " + outdir;
     if (exec().execute(cmd) != 0) {
         _error = "failed to execute extraction command";
         return false;
diff --git a/libpkgupd/builder.cc b/libpkgupd/builder.cc
index 85f2876..b27a345 100644
--- a/libpkgupd/builder.cc
+++ b/libpkgupd/builder.cc
@@ -43,7 +43,7 @@ bool builder::_prepare(std::vector<std::string> const &sources, std::string cons
 
         for (auto const &i : {".tar", ".gz", ".tgz", ".xz", ".txz", ".bzip2", ".bz", ".bz2", ".lzma"}) {
             if (endswith(outfile, i)) {
-                if (int status = exec().execute("tar -xaf " + outfile + " -C " + srcdir); status != 0) {
+                if (int status = exec().execute("tar -xPf " + outfile + " -C " + srcdir); status != 0) {
                     _error = "failed to extract " + outfile + " with tar, exit status: " + std::to_string(status);
                     return false;
                 }
-- 
2.30.2

